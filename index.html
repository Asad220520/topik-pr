<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–ª–æ–≤–∞ –∏ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –¢–æ–ø–∏–∫–∞</title>
  <style>
    body { background: #071028; color: #e6eef6; font-family: Inter, sans-serif; margin: 0; padding: 12px; }
    .container { max-width: 700px; margin: 0 auto; }
    h1 { text-align: center; margin: 12px 0; font-size: 22px; }
    h2 { text-align: center; margin: 8px 0; font-size: 16px; color: #60d39b; }
    select { width: 100%; margin-bottom: 12px; padding: 8px; border-radius: 8px; border: none; background: #152036; color: #e6eef6; }
    .tabs { display: flex; justify-content: space-around; margin-bottom: 12px; }
    .tabs button { flex: 1; padding: 10px; border: none; cursor: pointer; background: #152036; color: #9aa6b2; font-weight: 600; }
    .tabs button.active { background: #60d39b; color: #052018; }
    .card { background: #0f1724; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    button { background: #60d39b; border: none; color: #052018; padding: 10px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; margin: 4px 0; }
    .text-lang-btn { background: #152036; color: #60d39b; border: none; padding: 6px 10px; margin-left: 4px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .qa-item, .vocab-item { background: rgba(255, 255, 255, 0.04); border-radius: 8px; padding: 8px; margin-bottom: 6px; cursor: pointer; }
    .qa-item:hover, .vocab-item:hover { background: rgba(255, 255, 255, 0.1); }
    .qa-item h4 { margin: 0; font-size: 15px; }
    .qa-item .details { display: none; margin-top: 6px; font-size: 14px; color: #9aa6b2; }
    .qa-item.open .details { display: block; }
    .filter-input { padding: 6px; border-radius: 8px; border: none; width: 100%; margin-bottom: 8px; background: #152036; color: #e6eef6; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
    .modal.show { visibility: visible; opacity: 1; }
    .modal-content { background: #0f1724; padding: 20px; border-radius: 12px; width: 90%; max-width: 450px; }
    .modal-content input, .modal-content textarea { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 8px; border: none; background: #152036; color: #e6eef6; }
  </style>
</head>
<body>
<div class="container">
  <h1>–°–ª–æ–≤–∞ –∏ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –¢–æ–ø–∏–∫–∞</h1>
  <h2 id="lessonTitle"></h2>
  <select id="lessonSelect" onchange="switchLesson()"></select>

  <div class="tabs">
    <button id="tabBtnText" onclick="showTab('text')">–¢–µ–∫—Å—Ç</button>
    <button id="tabBtnQA" onclick="showTab('qa')">–í–æ–ø—Ä–æ—Å—ã</button>
    <button id="tabBtnVocab" onclick="showTab('vocab')">–°–ª–æ–≤–∞—Ä—å</button>
    <button id="tabBtnPractice" onclick="showTab('practice')">–ü—Ä–∞–∫—Ç–∏–∫–∞</button>
  </div>

  <!-- –¢–ï–ö–°–¢ -->
  <div id="tabText" class="tab-content">
    <div class="card">
      <div style="text-align: right; margin-bottom: 6px">
        <button class="text-lang-btn" onclick="switchTextLang('de')">DE</button>
        <button class="text-lang-btn" onclick="switchTextLang('ru')">RU</button>
      </div>
      <div id="lessonText" style="white-space: pre-line; cursor: pointer"></div>
      <button onclick="openTextModal()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
    </div>
  </div>

  <!-- –ü–†–ê–ö–¢–ò–ö–ê -->
  <div id="tabPractice" class="tab-content" style="display: none">
    <div class="card">
      <h3>–ü—Ä–∞–∫—Ç–∏–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤</h3>
      <div id="practiceQuestion"></div>
      <input type="text" id="practiceAnswer" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç –Ω–∞ DE" />
      <button onclick="checkAnswer()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      <div id="practiceFeedback" style="margin-top: 8px;"></div>
      <button onclick="nextQuestion()">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
    </div>
  </div>

  <!-- –í–û–ü–†–û–°–´ -->
  <div id="tabQa" class="tab-content" style="display: none">
    <div class="card">
      <div id="qaArea"></div>
      <button onclick="openQuestionModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
    </div>
  </div>

  <!-- –°–õ–û–í–ê–†–¨ -->
  <div id="tabVocab" class="tab-content" style="display: none">
    <div class="card">
      <input type="text" class="filter-input" id="vocabFilter" placeholder="–§–∏–ª—å—Ç—Ä —Å–ª–æ–≤" oninput="renderVocab()" />
      <div id="vocabArea"></div>
      <button onclick="openVocabModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ</button>
      <button onclick="clearVocab()">üóë –û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å</button>
    </div>
  </div>

  <!-- –°–ë–†–û–° -->
  <div style="text-align:center; margin-top: 20px;">
    <button onclick="resetLessons()">‚ôª –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ò -->
<div class="modal" id="textModal">
  <div class="modal-content">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</h3>
    <textarea id="modalTextDE" placeholder="–ù–µ–º–µ—Ü–∫–∏–π —Ç–µ–∫—Å—Ç"></textarea>
    <textarea id="modalTextRU" placeholder="–†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç"></textarea>
    <button onclick="saveText()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeTextModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<div class="modal" id="questionModal">
  <div class="modal-content">
    <h3>–í–æ–ø—Ä–æ—Å</h3>
    <input type="text" id="modalQuestion" placeholder="–í–æ–ø—Ä–æ—Å DE" />
    <input type="text" id="modalQuestionRU" placeholder="–í–æ–ø—Ä–æ—Å RU" />
    <input type="text" id="modalAnswer" placeholder="–û—Ç–≤–µ—Ç DE" />
    <input type="text" id="modalAnswerRU" placeholder="–û—Ç–≤–µ—Ç RU" />
    <button onclick="saveQuestion()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeQuestionModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<div class="modal" id="vocabModal">
  <div class="modal-content">
    <h3>–°–ª–æ–≤–æ</h3>
    <input type="text" id="modalDE" placeholder="DE" />
    <input type="text" id="modalRU" placeholder="RU" />
    <button onclick="saveVocab()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button onclick="closeVocabModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
let lessons = [];
let currentLessonId = null;
let editingQuestionIndex = null;
let editingVocabIndex = null;
let currentTextLang = "de";
let practiceIndex = 0;

// ===== –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ =====
function getCurrentLesson() {
  return lessons.find(l => l.id === currentLessonId);
}

function showTab(tab) {
  document.querySelectorAll(".tab-content").forEach(d => d.style.display = "none");
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));

  const tabIdMap = { text: "tabText", qa: "tabQa", vocab: "tabVocab", practice: "tabPractice" };
  const btnIdMap = { text: "tabBtnText", qa: "tabBtnQA", vocab: "tabBtnVocab", practice: "tabBtnPractice" };

  const tabId = tabIdMap[tab];
  const btnId = btnIdMap[tab];

  if(tabId) document.getElementById(tabId).style.display = "block";
  if(btnId) document.getElementById(btnId).classList.add("active");

  if(tab === "practice") startPractice();
}

// ===== –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≤—ã–±–æ—Ä —É—Ä–æ–∫–æ–≤ =====
async function loadLessons() {
  try {
    const saved = localStorage.getItem("lessons");
    if(saved) lessons = JSON.parse(saved);
    else {
      const response = await fetch("lessons.json");
      lessons = await response.json();
      localStorage.setItem("lessons", JSON.stringify(lessons));
    }
    currentLessonId = lessons[0]?.id || null;
    populateLessonSelect();
    renderAll();
    showTab("text");
  } catch (e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e); }
}

function resetLessons() {
  if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–Ω–æ–≤–æ –∏–∑ lessons.json?")) return;
  localStorage.removeItem("lessons");
  loadLessons();
}

function populateLessonSelect() {
  const sel = document.getElementById("lessonSelect");
  sel.innerHTML = lessons.map(l => `<option value="${l.id}">${l.title}</option>`).join("");
  sel.value = currentLessonId;
}

function switchLesson() {
  currentLessonId = document.getElementById("lessonSelect").value;
  renderAll();
}

// ===== –¢–µ–∫—Å—Ç —É—Ä–æ–∫–∞ =====
function switchTextLang(lang) {
  currentTextLang = lang;
  renderLessonText();
}

function renderLessonText() {
  const lesson = getCurrentLesson();
  const div = document.getElementById("lessonText");
  if(!lesson?.text) return;
  div.innerText = lesson.text[currentTextLang] || "";
  if(currentTextLang === "de") {
    div.style.cursor = "pointer";
    div.onclick = () => speakDE(lesson.text.de);
  } else {
    div.style.cursor = "default";
    div.onclick = null;
  }
}

function openTextModal() {
  const lesson = getCurrentLesson();
  document.getElementById("modalTextDE").value = lesson?.text?.de || "";
  document.getElementById("modalTextRU").value = lesson?.text?.ru || "";
  document.getElementById("textModal").classList.add("show");
}

function closeTextModal() { document.getElementById("textModal").classList.remove("show"); }

function saveText() {
  const lesson = getCurrentLesson();
  lesson.text.de = document.getElementById("modalTextDE").value;
  lesson.text.ru = document.getElementById("modalTextRU").value;
  localStorage.setItem("lessons", JSON.stringify(lessons));
  renderLessonText();
  closeTextModal();
}

// ===== –í–æ–ø—Ä–æ—Å—ã =====
function renderQA() {
  const qaArea = document.getElementById("qaArea");
  qaArea.innerHTML = "";
  const lesson = getCurrentLesson();
  if(!lesson?.questions) return;
  lesson.questions.forEach((q,i)=>{
    const div = document.createElement("div");
    div.className = "qa-item";
    div.innerHTML = `<h4>‚ùì ${q[0]}</h4>
      <div class="details"><b>RU:</b> ${q[1]}<br><b>DE –æ—Ç–≤–µ—Ç:</b> ${q[2]}<br><b>RU –æ—Ç–≤–µ—Ç:</b> ${q[3]}</div>`;
    div.addEventListener("click", ()=>div.classList.toggle("open"));
    div.addEventListener("dblclick", ()=>openQuestionModal(q[0], q[1], q[2], q[3], i));
    qaArea.appendChild(div);
  });
}

function openQuestionModal(q="", qru="", a="", aru="", index=null) {
  document.getElementById("modalQuestion").value = q;
  document.getElementById("modalQuestionRU").value = qru;
  document.getElementById("modalAnswer").value = a;
  document.getElementById("modalAnswerRU").value = aru;
  editingQuestionIndex = index;
  document.getElementById("questionModal").classList.add("show");
}

function closeQuestionModal() {
  document.getElementById("questionModal").classList.remove("show");
  editingQuestionIndex = null;
}

function saveQuestion() {
  const q = document.getElementById("modalQuestion").value;
  const qru = document.getElementById("modalQuestionRU").value;
  const a = document.getElementById("modalAnswer").value;
  const aru = document.getElementById("modalAnswerRU").value;
  const lesson = getCurrentLesson();
  if(editingQuestionIndex != null) lesson.questions[editingQuestionIndex] = [q,qru,a,aru];
  else lesson.questions.push([q,qru,a,aru]);
  localStorage.setItem("lessons", JSON.stringify(lessons));
  renderQA();
  closeQuestionModal();
}

// ===== –°–ª–æ–≤–∞—Ä—å =====
function renderVocab() {
  const area = document.getElementById("vocabArea");
  const filter = document.getElementById("vocabFilter").value.toLowerCase();
  area.innerHTML = "";
  const lesson = getCurrentLesson();
  if(!lesson?.vocab) return;
  lesson.vocab
    .filter(v=>v[0].toLowerCase().includes(filter) || v[1].toLowerCase().includes(filter))
    .forEach((v,i)=>{
      const div = document.createElement("div");
      div.className = "vocab-item";
      div.innerText = `${v[0]} ‚Äî ${v[1]}`;
      div.addEventListener("click", ()=>speakDE(v[0]));
      div.addEventListener("dblclick", ()=>openVocabModal(v[0], v[1], i));
      area.appendChild(div);
    });
}

function openVocabModal(de="", ru="", index=null) {
  document.getElementById("modalDE").value = de;
  document.getElementById("modalRU").value = ru;
  editingVocabIndex = index;
  document.getElementById("vocabModal").classList.add("show");
}

function closeVocabModal() {
  document.getElementById("vocabModal").classList.remove("show");
  editingVocabIndex = null;
}

function saveVocab() {
  const de = document.getElementById("modalDE").value;
  const ru = document.getElementById("modalRU").value;
  const lesson = getCurrentLesson();
  if(editingVocabIndex != null) lesson.vocab[editingVocabIndex] = [de,ru];
  else lesson.vocab.push([de,ru]);
  localStorage.setItem("lessons", JSON.stringify(lessons));
  renderVocab();
  closeVocabModal();
}

function clearVocab() {
  if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å?")) return;
  const lesson = getCurrentLesson();
  lesson.vocab = [];
  localStorage.setItem("lessons", JSON.stringify(lessons));
  renderVocab();
}

// ===== –ü—Ä–∞–∫—Ç–∏–∫–∞ =====
function startPractice() { practiceIndex = 0; showPracticeQuestion(); }

function showPracticeQuestion() {
  const lesson = getCurrentLesson();
  if(!lesson?.questions?.length) return;
  const q = lesson.questions[practiceIndex];
  document.getElementById("practiceQuestion").innerHTML = `<b>‚ùì ${q[0]}</b><br><i>${q[1]}</i>`;
  document.getElementById("practiceAnswer").value = "";
  document.getElementById("practiceFeedback").innerText = "";
}

function checkAnswer() {
  const lesson = getCurrentLesson();
  if(!lesson?.questions?.length) return;
  const q = lesson.questions[practiceIndex];
  const userAnswer = document.getElementById("practiceAnswer").value.trim().toLowerCase();
  const correctAnswer = q[2].trim().toLowerCase();
  const feedback = document.getElementById("practiceFeedback");
  if(userAnswer === correctAnswer) {
    feedback.innerText = "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!";
    speakDE(q[2]);
  } else {
    feedback.innerText = `‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${q[2]}`;
    speakDE(q[2]);
  }
}

function nextQuestion() {
  const lesson = getCurrentLesson();
  if(!lesson?.questions?.length) return;
  practiceIndex = (practiceIndex + 1) % lesson.questions.length;
  showPracticeQuestion();
}

// ===== –ì–æ–ª–æ—Å–æ–≤–æ–π –≤—ã–≤–æ–¥ =====
function speakDE(text) {
  if(!text) return;
  if("speechSynthesis" in window){
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = "de-DE";
    speechSynthesis.cancel();
    speechSynthesis.speak(ut);
  }
}

// ===== –û–±—â–∏–π —Ä–µ–Ω–¥–µ—Ä =====
function renderAll() {
  const lesson = getCurrentLesson();
  document.getElementById("lessonTitle").innerText = lesson?.title || "";
  renderLessonText();
  renderQA();
  renderVocab();
}

// ===== –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ =====
document.querySelectorAll(".modal").forEach(modal => {
  modal.addEventListener("click", e => {
    if(e.target === modal) modal.classList.remove("show");
  });
});

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
loadLessons();
</script>
</body>
</html>
