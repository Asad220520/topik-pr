<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –Ω–µ–º–µ—Ü–∫–æ–≥–æ ‚Äî –≥–æ–≤–æ—Ä–µ–Ω–∏–µ</title>
<style>
:root {
  --bg: #0b1220; --card: #0f1724; --muted: #9aa6b2; --accent: #60d39b;
}
* {box-sizing:border-box; font-family:Inter, system-ui, Segoe UI, Arial; margin:0;}
body {background: linear-gradient(180deg,#071028 0%,#081129 100%); color:#e6eef6; min-height:100vh; padding:12px;}
.container{max-width:900px;margin:0 auto;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
h1{font-size:18px;}
.small{font-size:13px;color:var(--muted);}
main{display:flex;flex-direction:column;gap:12px;}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6);}
textarea,input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;}
.text-edit{min-height:140px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);white-space:pre-wrap;overflow:auto;max-height:200px;}
button{background:var(--accent);border:none;color:#052018;padding:14px 16px;border-radius:12px;font-weight:600;width:100%;margin-bottom:6px;font-size:16px;}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:14px 16px;border-radius:12px;width:100%;font-size:16px;margin-bottom:6px;}
.row{display:flex;gap:8px;flex-wrap:wrap;}
.row .col{flex:1;min-width:45%;}
.german-scroll,.rus-scroll{overflow:auto;max-height:200px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.01);}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.9);display:flex;align-items:center;justify-content:center;padding:16px;}
.modal{background:var(--card);border-radius:12px;padding:16px;max-width:480px;width:100%;}
@media (min-width:800px){main{flex-direction:row;}.left{width:320px;}.right{flex:1;}button{width:auto;margin-bottom:0;font-size:14px;padding:10px 12px;}.btn-ghost{width:auto;margin-bottom:0;font-size:14px;padding:8px 10px;}}
</style>
</head>
<body>
<div class="container">
<header>
<div>
<h1>–¢–æ–ø–∏–∫</h1>
<div class="small">–£—á–µ–±–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã, —Å–ª–æ–≤–∞—Ä—å, –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã</div>
</div>
<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;width:100%;">
<button id="settingsBtn">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
<button id="newLessonBtn" class="btn-ghost">‚ûï –ù–æ–≤–∞—è</button>
</div>
</header>

<main>
<div class="left">
<div class="card">
<div class="small" style="margin-bottom:8px">–®–∞–±–ª–æ–Ω—ã</div>
<div id="lessonList"></div>
<div style="display:flex;flex-direction:column;gap:6px;margin-top:10px;">
<button onclick="importAll()" class="btn-ghost">–ò–º–ø–æ—Ä—Ç</button>
<button onclick="exportAll()" class="btn-ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
</div>
</div>

<div class="card" style="margin-top:12px">
<div class="small">–ü—Ä–∞–∫—Ç–∏–∫–∞</div>
<div style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
<button onclick="practiceRandom()">–°–ª—É—á. –≤–æ–ø—Ä–æ—Å</button>
<button onclick="revealLast()" class="btn-ghost">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
<button onclick="switchMode()" class="btn-ghost">‚Üî DE/–†–£</button>
</div>
<div id="practiceBox" style="margin-top:8px"></div>
</div>
</div>

<div class="right">
<div class="card">
<div class="small">–ù–µ–º–µ—Ü–∫–∏–π —Ç–µ–∫—Å—Ç</div>
<div id="germanText" class="text-edit german-scroll" contenteditable="true"></div>
<div class="controls" style="display:flex;flex-direction:column;gap:6px;margin-top:6px;">
<button onclick="speak('de', getGermanText())">üîä –ü—Ä–æ—á–∏—Ç–∞—Ç—å (DE)</button>
<button class="btn-ghost" onclick="autoExtractVocab()">–ê–≤—Ç–æ: –í–æ–∫–∞–±—É–ª—è—Ä</button>
<button class="btn-ghost" onclick="saveCurrent()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>

<div class="card" style="margin-top:12px">
<div class="small">–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º (—Ä—É—Å—Å–∫–∏–π)</div>
<div id="sentTranslations" class="text-edit rus-scroll" contenteditable="true"></div>
<div class="controls" style="display:flex;flex-direction:column;gap:6px;margin-top:6px;">
<button onclick="fillSentTranslations()">–†–∞–∑–±–∏—Ç—å –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º</button>
<button class="btn-ghost" onclick="speak('ru', document.getElementById('sentTranslations').innerText)">üîä –ü—Ä–æ—á–∏—Ç–∞—Ç—å (RU)</button>
</div>
</div>

<div class="card" style="margin-top:12px">
<div class="small">–°–ª–æ–≤–∞—Ä—å (DE ‚Üí RU)</div>
<div id="vocabArea" class="vocab-list"></div>
<div style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
<button onclick="addVocab()">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ</button>
<button class="btn-ghost" onclick="clearVocab()">–û—á–∏—Å—Ç–∏—Ç—å</button>
</div>
</div>

<div class="card" style="margin-top:12px">
<div class="small">–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã</div>
<div id="qaArea"></div>
<div style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
<button onclick="addQuestion()">–î–æ–±–∞–≤–∏—Ç—å</button>
<button class="btn-ghost" onclick="generateAnswers()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
</div>
</div>

<div style="display:flex;flex-direction:column;gap:6px;margin-top:12px;">
<button onclick="downloadTxt()">–°–∫–∞—á–∞—Ç—å .txt</button>
<button class="btn-ghost" onclick="resetSample()">–°–±—Ä–æ—Å–∏—Ç—å —à–∞–±–ª–æ–Ω—ã</button>
</div>
</div>
</main>

<footer>–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Ç–∫—Ä–æ–π ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è/–≥–æ—Ä–æ–¥/–≤—É–∑ ‚Äî –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —à–∞–±–ª–æ–Ω—ã.</footer>
</div>

<!-- modal settings -->
<div id="modal" style="display:none" class="modal-backdrop">
<div class="modal">
<h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
<div style="margin-top:8px">
<label class="small">–í–∞—à–µ –∏–º—è</label>
<input id="profileName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–π–≥–µ—Ä–∏–º" />
</div>
<div class="row" style="margin-top:8px">
<div class="col">
<label class="small">–ì–æ—Ä–æ–¥</label><input id="profileCity" placeholder="–ë–∏—à–∫–µ–∫" />
</div>
<div class="col">
<label class="small">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</label><input id="profileStudy" placeholder="–¢—É—Ä–∏–∑–º" />
</div>
</div>
<div style="display:flex;flex-direction:column;gap:6px;margin-top:12px;">
<button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button class="btn-ghost" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
</div>
</div>

<script>
// -------------------- –¥–∞–Ω–Ω—ã–µ --------------------
const SAMPLE=[
{id:"ueber-mich", title:"–û —Å–µ–±–µ –∏ —Å–µ–º—å–µ", german:`Ich hei√üe {name} und lerne seit vier Wochen Deutsch.\nIch studiere {study} an der Universit√§t in {city}.\nMeine Familie kommt aus der Region Issyk-Kul.\nWir sind f√ºnf Personen: meine Eltern, zwei Br√ºder und ich.\nIch wohne im Studentenwohnheim mit einer Freundin.`, sentRus:`–ú–µ–Ω—è –∑–æ–≤—É—Ç {name} –∏ —è —É—á—É –Ω–µ–º–µ—Ü–∫–∏–π —É–∂–µ —á–µ—Ç—ã—Ä–µ –Ω–µ–¥–µ–ª–∏.\n–Ø –∏–∑—É—á–∞—é {study} –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –≤ {city}.\n–ú–æ—è —Å–µ–º—å—è –∏–∑ —Ä–µ–≥–∏–æ–Ω–∞ –ò—Å—Å—ã–∫-–ö—É–ª—å.\n–ù–∞—Å –ø—è—Ç–µ—Ä–æ: —Ä–æ–¥–∏—Ç–µ–ª–∏, –¥–≤–∞ –±—Ä–∞—Ç–∞ –∏ —è.\n–Ø –∂–∏–≤—É –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ —Å –ø–æ–¥—Ä—É–≥–æ–π.`, vocab:[["hei√üen","–Ω–∞–∑—ã–≤–∞—Ç—å—Å—è"],["lernen","—É—á–∏—Ç—å"],["studieren","—É—á–∏—Ç—å—Å—è"],["Familie","—Å–µ–º—å—è"],["Studentenwohnheim","–æ–±—â–µ–∂–∏—Ç–∏–µ"]], questions:[["Wie hei√üen Sie?","Ich hei√üe {name}."],["Woher kommen Sie?","Ich komme aus Issyk-Kul."],["Was studieren Sie?","Ich studiere {study}."]]},
{id:"arbeitstag", title:"–ú–æ–π —É—á–µ–±–Ω—ã–π –¥–µ–Ω—å", german:`An Werktagen wache ich um 6:30 Uhr auf.\nIch brauche etwa anderthalb Stunden, um zur Universit√§t zu fahren.\nDer Unterricht beginnt um 9:00 und endet gegen 17:00.\nAm Abend besuche ich einen Deutschkurs.\nZu Hause essen wir zusammen und danach mache ich Hausaufgaben.`, sentRus:`–í –±—É–¥–Ω–∏ —è –≤—Å—Ç–∞—é –≤ 6:30.\n–Ø —Ç—Ä–∞—á—É –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–ª—Ç–æ—Ä–∞ —á–∞—Å–∞, —á—Ç–æ–±—ã –¥–æ–µ—Ö–∞—Ç—å –¥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.\n–ó–∞–Ω—è—Ç–∏—è –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ 9:00 –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –æ–∫–æ–ª–æ 17:00.\n–í–µ—á–µ—Ä–æ–º —è —Ö–æ–∂—É –Ω–∞ –∫—É—Ä—Å –Ω–µ–º–µ—Ü–∫–æ–≥–æ.\n–î–æ–º–∞ –º—ã —É–∂–∏–Ω–∞–µ–º –≤–º–µ—Å—Ç–µ, –∞ –∑–∞—Ç–µ–º —è –¥–µ–ª–∞—é –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è.`, vocab:[["aufwachen","–ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è"],["Unterricht","–∑–∞–Ω—è—Ç–∏—è"],["Deutschkurs","–∫—É—Ä—Å –Ω–µ–º–µ—Ü–∫–æ–≥–æ"],["Hausaufgaben","–¥–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞"]], questions:[["Wann stehen Sie auf?","Ich stehe um 6:30 auf."],["Wie lange brauchen Sie zur Uni?","Ich brauche etwa eineinhalb Stunden."]]},
{id:"studium", title:"–ú–æ—ë –æ–±—É—á–µ–Ω–∏–µ", german:`Ich studiere Englisch und englische Literatur an der nationalen Universit√§t in {city}.\nIch bin im dritten Studienjahr.\nMeine zweite Fremdsprache ist Deutsch; ich lerne sie seit drei Jahren.\nIch m√∂chte sp√§ter als Lehrerin in einer internationalen Schule arbeiten.`, sentRus:`–Ø –∏–∑—É—á–∞—é –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ –∏ –∞–Ω–≥–ª–∏–π—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –≤ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –≤ {city}.\n–Ø –Ω–∞ —Ç—Ä–µ—Ç—å–µ–º –∫—É—Ä—Å–µ.\n–ú–æ–π –≤—Ç–æ—Ä–æ–π –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π ‚Äî –Ω–µ–º–µ—Ü–∫–∏–π; —è —É—á—É –µ–≥–æ —É–∂–µ —Ç—Ä–∏ –≥–æ–¥–∞.\n–í –±—É–¥—É—â–µ–º —è —Ö–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å —É—á–∏—Ç–µ–ª–µ–º –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —à–∫–æ–ª–µ.`, vocab:[["Studium","—É—á—ë–±–∞"],["Literatur","–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞"],["Fremdsprache","–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫"],["Lehrerin","—É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞"]], questions:[["Was studieren Sie?","Ich studiere Englisch und englische Literatur."],["In welchem Studienjahr sind Sie?","Ich bin im dritten Studienjahr."]]}
];

let lessons=load()||SAMPLE.slice();
let currentId=lessons[0].id;
let lastPracticeIndex=null;
let practiceMode="DE";

// -------------------- —Ä–µ–Ω–¥–µ—Ä --------------------
function renderLessonList(){const list=document.getElementById("lessonList"); list.innerHTML=""; lessons.forEach(l=>{const el=document.createElement("div"); el.style.padding="10px"; el.style.borderRadius="8px"; el.style.marginBottom="8px"; el.style.background=l.id===currentId?"rgba(96,211,155,0.08)":"transparent"; el.style.cursor="pointer"; el.innerHTML=`<div style="font-weight:600">${l.title}</div><div class="small">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>`; el.onclick=()=>{currentId=l.id; renderEditor(); renderLessonList();}; list.appendChild(el);});}

function renderEditor(){const lesson=lessons.find(x=>x.id===currentId); document.getElementById("germanText").innerText=fillProfile(lesson.german); document.getElementById("sentTranslations").innerText=fillProfile(lesson.sentRus); renderVocab(lesson.vocab); renderQA(lesson.questions); save();}

function renderVocab(vocab){const area=document.getElementById("vocabArea"); area.innerHTML=""; vocab.forEach((v,i)=>{const el=document.createElement("div"); el.className="vocab-item"; el.style.display="flex"; el.style.justifyContent="space-between"; el.style.alignItems="center"; el.style.marginBottom="4px"; el.innerHTML=`<div>${escapeHtml(v[0])} ‚Äî ${escapeHtml(v[1])}</div><div style="display:flex;gap:6px"><button class='btn-ghost' onclick="editVocab(${i})">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class='btn-ghost' onclick="removeVocab(${i})">–£–¥–∞–ª–∏—Ç—å</button></div>`; area.appendChild(el);});}

// -------------------- –≤–æ–ø—Ä–æ—Å—ã --------------------
function renderQA(qa){
  const area=document.getElementById("qaArea"); area.innerHTML="";
  qa.forEach((q,i)=>{
    const el=document.createElement("div"); el.className="qa-item";
    el.style.padding="6px"; el.style.borderRadius="8px"; el.style.background="rgba(255,255,255,0.01)"; el.style.marginBottom="6px";
    el.innerHTML=`
      <div><strong>–í–æ–ø—Ä–æ—Å:</strong> ${escapeHtml(q[0])}</div>
      <div style="margin-top:4px"><strong>–û—Ç–≤–µ—Ç:</strong> ${escapeHtml(fillProfile(q[1]))}</div>
      <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap">
        <button class='btn-ghost' onclick="speak('de','${escapeJs(q[0])}')">üîä –í–æ–ø—Ä–æ—Å</button>
        <button class='btn-ghost' onclick="speak('de','${escapeJs(fillProfile(q[1]))}')">üîä –û—Ç–≤–µ—Ç</button>
        <button class='btn-ghost' onclick="editQuestion(${i})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button class='btn-ghost' onclick="removeQuestion(${i})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    area.appendChild(el);
  });
}

function addQuestion(){const q=prompt("–í–æ–ø—Ä–æ—Å (–Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º)"); if(!q) return; const a=prompt("–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–º)"); if(a==null) return; lessons.find(x=>x.id===currentId).questions.push([q,a]); renderQA(lessons.find(x=>x.id===currentId).questions); save();}
function editQuestion(i){const lesson=lessons.find(x=>x.id===currentId); const q=prompt("–í–æ–ø—Ä–æ—Å", lesson.questions[i][0]); if(q==null) return; const a=prompt("–û—Ç–≤–µ—Ç", lesson.questions[i][1]); if(a==null) return; lesson.questions[i]=[q,a]; renderQA(lesson.questions); save();}
function removeQuestion(i){if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?")) return; lessons.find(x=>x.id===currentId).questions.splice(i,1); renderQA(lessons.find(x=>x.id===currentId).questions); save();}
function generateAnswers(){const lesson=lessons.find(x=>x.id===currentId); lesson.questions=lesson.questions.map(q=>[q[0],fillProfile(q[1])]); renderQA(lesson.questions); save();}

// -------------------- –ø—Ä–∞–∫—Ç–∏–∫–∞ --------------------
function normalizeText(s){return s.replace(/[^\w–∞-—è—ë√§√∂√º√ü]+/gi," ").trim().toLowerCase();}
function practiceRandom(){const lesson=lessons.find(x=>x.id===currentId); if(!lesson.questions.length){alert("–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤"); return;} const idx=Math.floor(Math.random()*lesson.questions.length); lastPracticeIndex=idx; showPractice();}
function revealLast(){if(lastPracticeIndex===null) return; showPractice(true);}
function showPractice(showAnswer=false){
  const lesson=lessons.find(x=>x.id===currentId); if(lastPracticeIndex===null) return; const q=lesson.questions[lastPracticeIndex];
  const questionText=practiceMode==="DE"?q[0]:fillProfile(q[1]);
  const answerText=practiceMode==="DE"?fillProfile(q[1]):q[0];
  document.getElementById("practiceBox").innerHTML=`<div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">
  <strong>–í–æ–ø—Ä–æ—Å:</strong> ${escapeHtml(questionText)}
  ${showAnswer?`<br><strong>–û—Ç–≤–µ—Ç:</strong> ${escapeHtml(answerText)}`:""}
  <div style="margin-top:6px">
  <input type="text" id="userAnswer" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç" style="width:100%;padding:8px;border-radius:6px;margin-top:4px"/>
  <button onclick="checkAnswer()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
  <div id="feedback" style="margin-top:6px;color:#60d39b;"></div>
  </div>
  <div style="margin-top:6px">
  <button class='btn-ghost' onclick="speak('de','${escapeJs(questionText)}')">üîä –ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å</button>
  ${showAnswer?`<button class='btn-ghost' onclick="speak('de','${escapeJs(answerText)}')">üîä –ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç</button>`:""}
  </div></div>`;
}
function checkAnswer(){
  const lesson=lessons.find(x=>x.id===currentId); if(lastPracticeIndex===null) return;
  const user=document.getElementById("userAnswer").value;
  const correct=practiceMode==="DE"?lesson.questions[lastPracticeIndex][1]:lesson.questions[lastPracticeIndex][0];
  const fb=document.getElementById("feedback");
  fb.innerText=normalizeText(user)===normalizeText(fillProfile(correct))?"‚úÖ –í–µ—Ä–Ω–æ!":"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: "+correct;
}
function switchMode(){practiceMode=practiceMode==="DE"?"RU":"DE"; practiceRandom();}

// -------------------- –ø—Ä–æ—Ñ–∏–ª–∏ --------------------
document.getElementById("settingsBtn").addEventListener("click",()=>{openModal();});
function openModal(){const m=document.getElementById("modal"); document.getElementById("profileName").value=localStorage.getItem("ds_profile_name")||""; document.getElementById("profileCity").value=localStorage.getItem("ds_profile_city")||""; document.getElementById("profileStudy").value=localStorage.getItem("ds_profile_study")||""; m.style.display="flex";}
function closeModal(){document.getElementById("modal").style.display="none";}
function saveProfile(){localStorage.setItem("ds_profile_name",document.getElementById("profileName").value); localStorage.setItem("ds_profile_city",document.getElementById("profileCity").value); localStorage.setItem("ds_profile_study",document.getElementById("profileStudy").value); closeModal(); renderEditor();}
function fillProfile(s){if(!s) return""; const p={name:localStorage.getItem("ds_profile_name")||"{name}", city:localStorage.getItem("ds_profile_city")||"{city}", study:localStorage.getItem("ds_profile_study")||"{study}"}; return s.replace(/\{name\}/g,p.name).replace(/\{city\}/g,p.city).replace(/\{study\}/g,p.study);}
function getGermanText(){return document.getElementById("germanText").innerText;}
function fillSentTranslations(){const text=getGermanText(); const sents=text.split(/[\.\!\?]+/).map(s=>s.trim()).filter(Boolean); document.getElementById("sentTranslations").innerText=sents.join("\n");}

// -------------------- —Å–ª–æ–≤–∞—Ä—å --------------------
function addVocab(){const word=prompt("–ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ"); if(!word) return; const tr=prompt("–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π"); if(tr==null) return; const lesson=lessons.find(x=>x.id===currentId); lesson.vocab.push([word,tr]); renderVocab(lesson.vocab); save();}
function editVocab(i){const lesson=lessons.find(x=>x.id===currentId); const w=prompt("–ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ",lesson.vocab[i][0]); if(w==null) return; const t=prompt("–ü–µ—Ä–µ–≤–æ–¥",lesson.vocab[i][1]); if(t==null) return; lesson.vocab[i]=[w,t]; renderVocab(lesson.vocab); save();}
function removeVocab(i){lessons.find(x=>x.id===currentId).vocab.splice(i,1); renderVocab(lessons.find(x=>x.id===currentId).vocab); save();}
function clearVocab(){if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–ª–æ–≤–∞?")) return; lessons.find(x=>x.id===currentId).vocab=[]; renderVocab([]); save();}
function autoExtractVocab(){const text=getGermanText(); const words=Array.from(new Set(text.split(/[^A-Za-z√Ñ√ñ√ú√§√∂√º√ü]+/).filter(w=>w.length>2))); const probable=words.slice(0,30).map(w=>[w,""]); const lesson=lessons.find(x=>x.id===currentId); lesson.vocab=probable; renderVocab(lesson.vocab); save(); alert("–í–æ–∫–∞–±—É–ª—è—Ä –∏–∑–≤–ª–µ—á—ë–Ω, –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–≤–æ–¥—ã");}

// -------------------- TTS --------------------
function speak(lang,text){if(!text) return; if("speechSynthesis"in window){const ut=new SpeechSynthesisUtterance(text); ut.lang=lang==="de"?"de-DE":lang==="ru"?"ru-RU":"en-US"; speechSynthesis.cancel(); speechSynthesis.speak(ut);} else alert("TTS –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ");}

// -------------------- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ --------------------
function save(){localStorage.setItem("ds_lessons",JSON.stringify(lessons));}
function load(){try{return JSON.parse(localStorage.getItem("ds_lessons"));}catch(e){return null;}}

function saveCurrent(){const lesson=lessons.find(x=>x.id===currentId); lesson.german=document.getElementById("germanText").innerText; lesson.sentRus=document.getElementById("sentTranslations").innerText; save(); alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");}
document.getElementById("newLessonBtn").addEventListener("click",()=>{const id="lesson-"+Date.now(); lessons.unshift({id,title:"–ù–æ–≤—ã–π —É—Ä–æ–∫",german:"–ù–∞–ø–∏—à–∏—Ç–µ –Ω–µ–º–µ—Ü–∫–∏–π —Ç–µ–∫—Å—Ç...",sentRus:"–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º...",vocab:[],questions:[]}); currentId=lessons[0].id; renderLessonList(); renderEditor(); save();});

// -------------------- —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç --------------------
function exportAll(){const data=JSON.stringify(lessons); const blob=new Blob([data],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="lessons.json"; document.body.appendChild(a); a.click(); a.remove();}
function importAll(){const input=document.createElement("input"); input.type="file"; input.accept="application/json"; input.onchange=e=>{const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{try{lessons=JSON.parse(ev.target.result); currentId=lessons[0].id; renderLessonList(); renderEditor(); save(); alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");}catch(err){alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");}}; r.readAsText(f);}; input.click();}
function downloadTxt(){const lesson=lessons.find(x=>x.id===currentId); const txt=`–£—Ä–æ–∫: ${lesson.title}\n\nDE:\n${lesson.german}\n\nRU (–ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º):\n${lesson.sentRus}\n\n–°–ª–æ–≤–∞—Ä—å:\n${lesson.vocab.map(v=>v.join(" - ")).join("\n")}\n\n–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã:\n${lesson.questions.map(q=>q.join(" - ")).join("\n")}`; const blob=new Blob([txt],{type:"text/plain;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=(lesson.title.replace(/\s/g,"_")||"lesson")+".txt"; document.body.appendChild(a); a.click(); a.remove();}
function resetSample(){if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —É—Ä–æ–∫–∏ –∫ —à–∞–±–ª–æ–Ω–∞–º? –í—Å–µ –≤–∞—à–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.")) return; lessons=SAMPLE.slice(); currentId=lessons[0].id; renderLessonList(); renderEditor(); save();}

// -------------------- —É—Ç–∏–ª–∏—Ç—ã --------------------
function escapeHtml(s){return(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function escapeJs(s){return(s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\"/g,'\\"').replace(/\n/g," ");}

// -------------------- init --------------------
(function init(){const saved=load(); if(saved&&saved.length) lessons=saved; renderLessonList(); renderEditor();})();
</script>
</body>
</html>
